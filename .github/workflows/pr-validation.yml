name: PR Validation and Deploy to DEV

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**'
      - 'databricks.yml'
      - '.github/workflows/pr-validation.yml'

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    name: Validate PR and Deploy to DEV
    environment: development
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Databricks CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
          echo "$HOME/.databricks/bin" >> $GITHUB_PATH
      
      - name: Validate Bundle Configuration
        env:
          DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          echo "Validating Databricks bundle configuration..."
          databricks bundle validate -t dev
      
      - name: Deploy ALL Use Cases to DEV
        env:
          DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          echo "================================================"
          echo "Deploying ALL use cases + shared to DEV environment"
          echo "This deployment is for PR validation purposes"
          echo "================================================"
          
          # Deploy using bundle (includes all paths defined in dev target)
          databricks bundle deploy -t dev --auto-approve
          
          echo "Bundle deployment completed"
          echo "Note: In development mode, deployed to user-specific workspace"
      
      - name: Verify Deployment
        env:
          DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          echo "Deployment completed to DEV workspace"
          echo "----------------------------------------"
          echo "In development mode, notebooks are deployed to:"
          echo "  ~/Deployments/dev/shared"
          echo "  ~/Deployments/dev/usecase-1"
          echo "  ~/Deployments/dev/usecase-2"
          echo ""
          echo "This resolves to the user's personal workspace in Databricks"
      
      - name: Run Deployment Validation
        env:
          DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          # Install dependencies for validation script
          pip install requests
          
          # Run validation
          python devops/scripts/validate_deployment.py \
            --env dev \
            --host "$DATABRICKS_HOST" \
            --validate-all
      
      - name: Deployment Summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "## ✅ DEV Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All use cases and shared notebooks have been deployed to the DEV environment." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Deployed Assets:**" >> $GITHUB_STEP_SUMMARY
            echo "- ✓ Shared notebooks" >> $GITHUB_STEP_SUMMARY
            echo "- ✓ Use Case 1 notebooks" >> $GITHUB_STEP_SUMMARY
            echo "- ✓ Use Case 2 notebooks" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Workspace Path:** /Workspace/Deployments/dev/" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ❌ DEV Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Common issues:**" >> $GITHUB_STEP_SUMMARY
            echo "- Invalid Databricks configuration" >> $GITHUB_STEP_SUMMARY
            echo "- Missing notebooks or incorrect paths" >> $GITHUB_STEP_SUMMARY
            echo "- Authentication issues" >> $GITHUB_STEP_SUMMARY
          fi